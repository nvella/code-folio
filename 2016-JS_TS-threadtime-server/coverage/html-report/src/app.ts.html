<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for src/app.ts</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../prettify.css" />
    <link rel="stylesheet" href="../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../index.html">all files</a> / <a href="index.html">src/</a> app.ts
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">93.85% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>61/65</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">66.67% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>12/18</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">89.47% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>17/19</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">94.74% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>54/57</span>
      </div>
    </div>
  </div>
  <div class='status-line high'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112</td><td class="line-coverage quiet"><span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">26×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">50×</span>
<span class="cline-any cline-yes">25×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">25×</span>
<span class="cline-any cline-yes">25×</span>
<span class="cline-any cline-yes">25×</span>
<span class="cline-any cline-yes">25×</span>
<span class="cline-any cline-yes">25×</span>
<span class="cline-any cline-yes">25×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">25×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">25×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">25×</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">21×</span>
<span class="cline-any cline-yes">20×</span>
<span class="cline-any cline-yes">20×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">20×</span>
<span class="cline-any cline-yes">20×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">20×</span>
<span class="cline-any cline-yes">20×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">20×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">20×</span>
<span class="cline-any cline-yes">20×</span>
<span class="cline-any cline-yes">60×</span>
<span class="cline-any cline-yes">60×</span>
<span class="cline-any cline-yes">60×</span>
<span class="cline-any cline-yes">60×</span>
<span class="cline-any cline-yes">60×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">20×</span>
<span class="cline-any cline-yes">20×</span>
<span class="cline-any cline-yes">20×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">21×</span>
<span class="cline-any cline-yes">20×</span>
<span class="cline-any cline-yes">20×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">20×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">20×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">20×</span>
<span class="cline-any cline-yes">20×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">31×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span></td><td class="text"><pre class="prettyprint lang-js">import * as sio from 'socket.io';
import * as http from 'http';
import * as winston from 'winston';
import * as async from 'async';
import { MongoClient, Db as MongoDb, Collection as MongoCollection, MongoCallback } from 'mongodb';
import { EventEmitter } from 'events';
import * as _ from 'lodash';
&nbsp;
import { Client } from './client';
import { CollectionMap } from './collection_map';
&nbsp;
import { ObjType } from '@threadtime/threadtime-common';
&nbsp;
export class App extends EventEmitter {
    static VERSION = '0.0.1';
&nbsp;
    public port: number;
    public clients: Client[];
    public log: winston.LoggerInstance;
&nbsp;
    public dbUri: string;
    public db: MongoDb;
    public collections: {[key: string]: MongoCollection};
&nbsp;
    private http: http.Server;
    private io: SocketIO.Server;
&nbsp;
    constructor(port: number =process.env.PORT || 3000, <span class="missing-if-branch" title="else path not taken" >E</span>dbUri: string = process.env.DB_URI || 'mongodb://localhost/threadtime') {
        super();
&nbsp;
        this.port = port;
        this.dbUri = dbUri;
        this.http = http.createServer();
        this.io = sio(this.http);
        this.clients = [];
        this.collections = {};
&nbsp;
        // Set up log
        this.log = new winston.Logger({ transports: [
            new winston.transports.Console({'timestamp': true}) 
        ]});
&nbsp;
        this.io.on('connection', (socket) =&gt; {
            // Create new client
            let client = new Client(this, socket);
            // Add it to the clients list
            this.clients.push(client);
            // Start the client
            client.start();
        });
&nbsp;
        this.on('client_disconnect', (client: Client) =&gt; {
            _.pull(this.clients, client);
        });
    }
&nbsp;
    // Start the server
    start(<span class="missing-if-branch" title="if path not taken" >I</span>done: (err?: any) =&gt; void = <span class="fstat-no" title="function not covered" >() =&gt; {</span>}): void {
        this.log.info(`Threadtime Server version ${App.VERSION} starting...`);
        async.series([
            (callback) =&gt; { // Connect the database
                MongoClient.connect(this.dbUri, (err: any, db: MongoDb) =&gt; {
                    <span class="missing-if-branch" title="if path not taken" >I</span>if(err) {
<span class="cstat-no" title="statement not covered" >                        this.log.error(err);</span>
<span class="cstat-no" title="statement not covered" >                        return callback(err);</span>
                    }
&nbsp;
                    this.log.info('Database connected.');
                    this.db = db;
&nbsp;
                    callback();
                });
            },
            (callback) =&gt; {
                this.log.info('Connecting collections...');
                async.forEachOf(CollectionMap, (col: string, type: any, callback: Function) =&gt; {
                    this.log.info(`    ${col}...`);
                    this.db.collection(col, (err: any, mongocol: MongoCollection) =&gt; {
                        <span class="missing-if-branch" title="if path not taken" >I</span>if(err) <span class="cstat-no" title="statement not covered" >callback(err);</span>
                        this.collections[col] = mongocol;
                        callback();
                    });
                }, callback);
            },
            (callback) =&gt; this.http.listen(this.port, () =&gt; { // Open the HTTP server
                this.log.info(`Now listening on ${this.port}`);
                callback();
            })
        ], done);
    }
&nbsp;
    // Stop the server
    stop(<span class="missing-if-branch" title="if path not taken" >I</span>done: (err?: any) =&gt; void = <span class="fstat-no" title="function not covered" >() =&gt; {</span>}): void {
        this.io.close(); // Stop the socket IO instance
        async.series([
            (callback) =&gt; { // Stop the HTTP server
                <span class="missing-if-branch" title="if path not taken" >I</span>if(this.http.listening) {
<span class="cstat-no" title="statement not covered" >                    this.http.close(callback);</span>
                } else {
                    callback();
                }
            },
            (callback) =&gt; this.db.close(true, callback as any), // Disconnect the DB
            (callback) =&gt; { this.log.info('Server stopped.'); callback(); }
        ], done);
    }
&nbsp;
    // Easy shortcut for fetching a collection for a specific ObjType
    collectionFor(type: ObjType): MongoCollection {
        return this.collections[CollectionMap[type]];
    }
}</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Mon Oct 31 2016 16:55:39 GMT+1100 (AEDT)
</div>
</div>
<script src="../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../sorter.js"></script>
</body>
</html>
