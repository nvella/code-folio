<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for src/Objs/Obj.ts</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../../prettify.css" />
    <link rel="stylesheet" href="../../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../../index.html">All files</a> / <a href="index.html">src/Objs</a> Obj.ts
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">95.65% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>66/69</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>14/14</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">89.29% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>25/28</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">94.44% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>51/54</span>
      </div>
    </div>
  </div>
  <div class='status-line high'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">125x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">125x</span>
<span class="cline-any cline-yes">125x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-yes">8x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">55x</span>
<span class="cline-any cline-yes">55x</span>
<span class="cline-any cline-yes">55x</span>
<span class="cline-any cline-yes">55x</span>
<span class="cline-any cline-yes">52x</span>
<span class="cline-any cline-yes">52x</span>
<span class="cline-any cline-yes">52x</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">12x</span>
<span class="cline-any cline-yes">12x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">12x</span>
<span class="cline-any cline-yes">12x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">11x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">11x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3x</span>
<span class="cline-any cline-yes">3x</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">23x</span>
<span class="cline-any cline-yes">23x</span>
<span class="cline-any cline-yes">23x</span>
<span class="cline-any cline-yes">23x</span>
<span class="cline-any cline-yes">30x</span>
<span class="cline-any cline-yes">30x</span>
<span class="cline-any cline-yes">30x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">23x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">95x</span>
<span class="cline-any cline-yes">50x</span>
<span class="cline-any cline-yes">50x</span>
<span class="cline-any cline-yes">50x</span>
<span class="cline-any cline-yes">21x</span>
<span class="cline-any cline-yes">21x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">15x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">6x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">5x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">6x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span></td><td class="text"><pre class="prettyprint lang-js">import * as mongodb from 'mongodb';
import * as shortid from 'shortid';
import * as async from 'async';
import * as _ from 'lodash';
import * as Joi from 'joi';
&nbsp;
import { IObj, ObjType, ObjSchemaMap, Obj as ObjCommon, IObjValidation } from '@threadtime/threadtime-common';
import {App} from "../App";
import {ObjNotFoundError, ValidationError as ValidationErrorLocal} from "../Errors";
&nbsp;
// Generic object class
export class Obj extends ObjCommon implements IObj {
    private app: App;
    private collection: mongodb.Collection;
&nbsp;
    /**
     * Represents an Obj in Threadtime, server-side.
     * @param app Threadtime Server App instance
     * @param id Threadtime Obj ID
     */
    constructor(app: App, id?: string) {
        super(id);
&nbsp;
        this.app = app;
        this.collection = this.app.collections['objects'];
    }
&nbsp;
    get owner(): Obj {
        return new Obj(this.app, this.ownerId);
    }
&nbsp;
    set owner(obj: Obj) {
        this.ownerId = obj._id;
    }
&nbsp;
    get parents(): Obj[] {
        return this.parentIds.map((id: string) =&gt; {
            return new Obj(this.app, id);
        });
    }
&nbsp;
    /** Load the document from the relevant collection in the database
     *
     * @returns {Promise&lt;void&gt;|Promise} Promise resolved when document loaded, rejected on failure
     */
    load(): Promise&lt;void&gt; {
        return new Promise&lt;void&gt;((resolve, reject) =&gt; {
            this.collection.find({_id: this._id}).limit(1).toArray().then((docs: Object[]) =&gt; {
                if(_.isEmpty(docs)) return reject(new ObjNotFoundError());
                let doc = docs[0];
                this.setProps(doc);
                resolve();
            }).catch(<span class="fstat-no" title="function not covered" >(</span>err) =&gt; <span class="cstat-no" title="statement not covered" >reject(err))</span>;
        });
    }
&nbsp;
    /**
     * Saves the object to the database
     * @returns {Promise&lt;void&gt;|Promise}
     */
    save(): Promise&lt;void&gt; {
        return new Promise&lt;void&gt;((resolve, reject) =&gt; {
            // Validate first
            let validation = this.validate();
            if(!validation.success) return reject(new ValidationErrorLocal('an Obj validation error occurred', &lt;Joi.ValidationError&gt;&lt;any&gt;validation.error)); // TODO return with validation data
&nbsp;
            let obj = this.getProps();
&nbsp;
            return this.collection.updateOne({_id: this._id}, obj, {upsert: true}).then(() =&gt; resolve());
        });
    }
&nbsp;
    /**
     * Saves the object to the database and emits an event onto the SystemBus
     * @returns {Promise&lt;void&gt;|Promise}
     */
    update(): Promise&lt;void&gt; {
        return new Promise&lt;void&gt;((resolve, reject) =&gt; {
            this.save().then(() =&gt; {
                // Emit the new serialized obj onto the system bus
                this.app.systemBus.emit('obj', this.getProps());
                resolve();
            }).catch(<span class="fstat-no" title="function not covered" >(</span>err) =&gt; <span class="cstat-no" title="statement not covered" >reject(err))</span>;
        });
    }
&nbsp;
    /**
     * Gets an array of Obj representing this object's children
     * @returns {Promise&lt;Obj[]&gt;|Promise}
     */
    getChildren(): Promise&lt;Obj[]&gt; {
        return new Promise&lt;Obj[]&gt;((resolve) =&gt; {
            this.collection.find({parentIds: this._id}).toArray().then((docs: Object[]) =&gt; {
                let objs: Obj[] = docs.map((doc: any) =&gt; {
                    let obj = new Obj(this.app, doc['_id']);
                    obj.setProps(doc);
                    return obj;
                }) as any as Obj[];
                resolve(objs);
            });
        });
    }
&nbsp;
    /**
     * Recursive get all the children of this object
     * @param maxLevel Maximum number of levels to crawl.
     * @param level Internal use only - current level
     * @returns {Promise&lt;Obj[]&gt;|Promise} Promised resolved with flat array of objects
     */
    getChildrenTree(maxLevel: number, level: number = 0): Promise&lt;Obj[]&gt; {
        if(level === 0) maxLevel--;
        return new Promise&lt;Obj[]&gt;((resolve, reject) =&gt; {
            if(maxLevel &lt; 0) return resolve([]); // Resolve nothing if no levels are requested
            this.getChildren().then((objs: Obj[]) =&gt; {
                if(level &gt;= maxLevel) {
                    // Reached the max number of levels, return these children only and don't crawl
                    return resolve(objs);
                } else {
                    // Run another pass of getChildrenRecursive, concat those children to our children, and return
                    async.concat(
                        objs,
                        (child: Obj, cb: Function) =&gt; child.getChildrenTree(maxLevel, level + 1).then((children) =&gt; cb(null, children)),
                        (err: any, children: Obj[]) =&gt; {
                            resolve(objs.concat(children));
                        }
                    );
                }
            }).catch(<span class="fstat-no" title="function not covered" >(</span>err) =&gt; <span class="cstat-no" title="statement not covered" >reject(err))</span>;
        });
    }
}</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Fri Dec 09 2016 19:38:08 GMT+1100 (AEDT)
</div>
</div>
<script src="../../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../../sorter.js"></script>
</body>
</html>
